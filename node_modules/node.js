const { SerialPort } = require('serialport');
const { ReadlineParser } = require('@serialport/parser-readline');

// CONFIGURACIÃ“N
// En Windows suele ser 'COM3', 'COM4'. En Linux/Mac '/dev/ttyUSB0'
const portPath = 'COM3'; 
const baudRate = 9600; // Debe coincidir con la configuraciÃ³n de tu mÃ³dulo LoRa

// Inicializar la conexiÃ³n
const port = new SerialPort({
  path: portPath,
  baudRate: baudRate,
});

// Usar un parser para leer lÃ­neas completas de texto
const parser = port.pipe(new ReadlineParser({ delimiter: '\r\n' }));

// 1. Evento: Puerto Abierto
port.on('open', () => {
  console.log(`âœ… ConexiÃ³n serial abierta en ${portPath}`);
  
  // Enviar un mensaje al llavero cada 5 segundos
  setInterval(() => {
    const mensaje = "PING_DESDE_PC";
    console.log(`Enviando: ${mensaje}`);
    port.write(mensaje + '\n');
  }, 5000);
});

// 2. Evento: Recibir datos del Llavero
parser.on('data', (data) => {
  console.log(`ðŸ“© Recibido del llavero: ${data}`);
  // AquÃ­ podrÃ­as procesar datos, ej: coordenadas GPS
});

// 3. Manejo de Errores
port.on('error', (err) => {
  console.error('Error: ', err.message);
});